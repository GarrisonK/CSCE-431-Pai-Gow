<html>

	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
        <script type="text/javascript" src="paper.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>

	<title>Pai Gow</title>

	<body>

		<script>

            paper.install(window);

            var tileWidth = 75;
            var tileHeight = 150;
            var bet5ButtonInfo = [50,500,50,25];
            var betLockButtonInfo = [50,400,50,25];
            var selectionLockButtonInfo = [50,450,50,25];

            var tileLocations = [[665,545],[750,545],[98,72],[182,72],[286,72],[370,72],[478,74],[562,74],[666,74],[750,74],[97,229],[181,229],[285,229],[369,229],[477,231],[561,231],[655,231],[749,231],[96,386],[180,386],[284,386],[368,386],[476,388],[560,388],[664,388],[748,388],[96,543],[180,543],[284,543],[368,543],[476,545],[560,545]];

            var dealerTileLocations = [[400,90],[400+1*(tileWidth/2+5),90],[400+2*(tileWidth/2+5),90],[400+3*(tileWidth/2+5),90]];
            var seatTileLocations = [[400,450],[400+1*(tileWidth/2+5),450],[400+2*(tileWidth/2+5),450],[400+3*(tileWidth/2+5),450]];

            var tileX = 75;
            var tileY = 150;

            $(function(){

                paper.setup('game');

                var c = document.getElementById("game");
                var ctx = c.getContext('2d');
                // ctx.fillStyle = "#003300";
                // ctx.fillRect(0,0,150,75);

                // var path;
                // function onMouseDown(event){
                //     path = new Path();
                //     path.strokeColor = "black";
                //     path.add(event.point);
                // }

                // var tool = new Tool();
                // tool.onMouseDown = onMouseDown;
                // tool.onMouseDrag = function(event){
                //     path.add(event.point);
                // }

                // view.onFrame = function(event){
                //     // console.log("test");
                //     ctx.fillStyle = "#003300";
                //     ctx.fill();
                // };

                var tileImage = new Image();
                var tileReady = false;
                tileImage.src = "/tiles.png";
                tileImage.onload = function(){
                    tileReady = true;
                }

                drawTile = function(id,x,y){
                    ctx.drawImage(tileImage,tileLocations[id][0],tileLocations[id][1],tileWidth,tileHeight,x,y,tileWidth/2,tileHeight/2);
                }

                drawPlayerTiles = function(){
                    if(game.state == "dealing" || game.state == "pair selection" || game.state == "tile reveal"){
                        drawTile(game.tiles[0],seatTileLocations[0][0],seatTileLocations[0][1]);
                        drawTile(game.tiles[1],seatTileLocations[1][0],seatTileLocations[1][1]);
                        drawTile(game.tiles[2],seatTileLocations[2][0],seatTileLocations[2][1]);
                        drawTile(game.tiles[3],seatTileLocations[3][0],seatTileLocations[3][1]);
                    }
                }

                drawDealerTiles = function(){
                    if(game.state == "dealing" || game.state == "pair selection"){
                        drawTileBack(dealerTileLocations[0][0],dealerTileLocations[0][1]);
                        drawTileBack(dealerTileLocations[1][0],dealerTileLocations[1][1]);
                        drawTileBack(dealerTileLocations[2][0],dealerTileLocations[2][1]);
                        drawTileBack(dealerTileLocations[3][0],dealerTileLocations[3][1]);
                    }
                    else if(game.state == 'tile reveal'){
                        drawTile(game.dealerTiles[0],dealerTileLocations[0][0],dealerTileLocations[0][1]);
                        drawTile(game.dealerTiles[1],dealerTileLocations[1][0],dealerTileLocations[1][1]);
                        drawTile(game.dealerTiles[2],dealerTileLocations[2][0],dealerTileLocations[2][1]);
                        drawTile(game.dealerTiles[3],dealerTileLocations[3][0],dealerTileLocations[3][1]);
                    }
                }


                drawBankerSymbol = function(x,y){
                    //x,y are the coordinates of the top left corner of the banker symbol
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(x,y,20,20);
                }

                drawTileBack = function(x,y){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(x,y,tileWidth/2,tileHeight/2);
                }

                drawBettingButtons = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(bet5ButtonInfo[0],bet5ButtonInfo[1],bet5ButtonInfo[2],bet5ButtonInfo[3]);
                }

                drawSelectionLockButtons = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(selectionLockButtonInfo[0],selectionLockButtonInfo[1],selectionLockButtonInfo[2],selectionLockButtonInfo[3]);
                    if(game.selectionLocked){
                        ctx.fillStyle = "#FF0000";
                        ctx.fillText("LOCKED",selectionLockButtonInfo[0],selectionLockButtonInfo[1]);
                    }
                    else{
                        ctx.fillStyle = "#006600";
                        ctx.fillText("UNLOCKED",selectionLockButtonInfo[0],selectionLockButtonInfo[1]);
                    }
                }

                drawBetLockButton = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(betLockButtonInfo[0],betLockButtonInfo[1],betLockButtonInfo[2],betLockButtonInfo[3]);
                    if(game.betsLocked){
                        ctx.fillStyle = "#FF0000";
                        ctx.fillText("LOCKED",betLockButtonInfo[0],betLockButtonInfo[1]);
                    }
                    else{
                        ctx.fillStyle = "#006600";
                        ctx.fillText("UNLOCKED",betLockButtonInfo[0],betLockButtonInfo[1]);
                    }

                }

                drawWagers = function(){
                    ctx.fillStyle = "#000000";
                    ctx.font = '20pt Calibri';
                    ctx.fillText("Wager: "+game.bet,c.width/2,400);
                    ctx.fillText("Dealer wager: "+game.minimumBet,c.width/2,200);
                }

                render = function(){
                    
                    //Fill background
                    ctx.fillStyle = "#003300";
                    ctx.fillRect(0,0,c.width,c.height);

                    //Draw pot
                    ctx.fillStyle = "#000000";
                    ctx.beginPath();
                    ctx.arc(c.width/2,c.height/2,50,0,2*Math.PI);
                    ctx.stroke();

                    //Draw game state
                    ctx.fillText("State: "+game.state,20,20);

                    drawBetLockButton();

                    ctx.fillStyle = "#000000";
                    ctx.fillText("Wallet: "+game.wallet,0,c.height);

                    // highlight pair selection
                    for(var i = 0; i < 4; i++){
                        if(game.clickedTiles.indexOf(i) != -1){
                            ctx.fillStyle = "#FFFF00";
                            ctx.fillRect(seatTileLocations[i][0]+25,seatTileLocations[i][1]-25,10,10);
                        }
                    }


                    if(game.banker == -1){
                        drawBankerSymbol(500,30);
                    }
                    else{
                        drawBankerSymbol(500,550);
                    }

                    if(tileReady){
                        // ctx.drawImage(tileImage,tileLocations[0][0],tileLocations[0][1],tileWidth,tileHeight,100,100,tileWidth/2,tileHeight/2);

                        // drawTile(0,dealerTileLocations[0][0],dealerTileLocations[0][1]);
                        // drawTile(1,dealerTileLocations[1][0],dealerTileLocations[1][1]);
                        // drawTile(2,dealerTileLocations[2][0],dealerTileLocations[2][1]);

                        // drawTile(0,seatTileLocations[0][0],seatTileLocations[0][1]);
                        // drawTile(1,seatTileLocations[1][0],seatTileLocations[1][1]);
                        // drawTile(2,seatTileLocations[2][0],seatTileLocations[2][1]);
                        // drawTile(30,seatTileLocations[3][0],seatTileLocations[3][1]);

                        drawPlayerTiles();
                        drawDealerTiles();

                    }
                    // drawTileBack(50,50);
                    drawWagers();
                    drawBettingButtons();
                    drawSelectionLockButtons();
                }

                setInterval(function(){
                    render();
                },100)
                // paper.view.draw();
            });

			var dots = [3,6,12,12,2,2,8,8,4,4,10,10,6,6,4,4,11,11,10,10,7,7,6,6,9,9,8,8,7,7,5,5];
			var tileNames = ["Gee Joon","Gee Joon","Teen","Teen","Day","Day","Yun","Yun","Gor","Gor","Mooy","Mooy","Chong","Chong","Bon","Bon","Foo","Foo","Ping","Ping","Tit","Tit","Look","Look","Chop Gow","Chop Gow","Chop Bot","Chop Bot","Chop Chit","Chot Chit","Chop Ng","Chop Ng"];
			var ranks = [1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16];

            var tileDivNames = ["#one","#two","#three","#four"];

			var socket = io.connect();
			var wallet = 0;
			var bet = 0;
			var game = new Object();
			game['wallet'] = 0;
			game['bet'] = 0;
			game['minimumBet'] = 0;
			game['betsLocked'] = false;
			game['state'] = "pregame";
			game['stateChangeTime'] = 5000;
			game['lastStateChange'] = 0;
			game['banker'] = -1;
			game['tiles'] = [];
			game['selectedTiles'] = [];
			game['selectionLocked'] = false;
            game['clickedTiles'] = [];  //Contains the index 0-3 of the tile that was clicked
            game['lastConfirmedSelection'] = []; //the last verified valid selection, is used if the player ends selection phase unlocked
            game['dealerTiles'] = [];

			var updateGameInfo = function(){
                //Prints seconds remaining, game state, etc
				var d = new Date();
				var t = (game.stateChangeTime-(d.getTime()-game.lastStateChange))
				t=t/1000;
				if(t<0){
					t = 0;
				}
				$("#gameInformation").empty();
	    		$("#gameInformation").html("Seconds remaining: "+t+"<br>Game state: "+game.state+"<br>Current bet: $"+game.bet+"<br>Wallet: $"+game.wallet+"<br>Tile selection: "+game.selectedTiles+"<br>Banker: "+game.banker);

			}

            //called to reset all information to begin a new game
            function resetGameInfo(){
                game.bet = game.minimumBet;
                game.betsLocked = false;
                game.tiles = [];
                game. selectedTiles = [];
                game.selectionLocked = false;
                game.lastConfirmedSelection = [];
                game.dealerTiles = [];
                // resetTileDivs();
                game.clickedTiles = [];
            }

            function resetTileDivs(){
                var divs = $('#one, #two, #three, #four');
                for(var i = 0; i < divs.length; i++){
                    divs.eq(i).empty();
                    divs.eq(i).removeClass('tileSelected').addClass('tile');
                }
            }

            //takes a pair and highlights those tiles
            var highlightTiles = function(pair){
                // var divs = $('#one, #two, #three, #four');

                // for(var i = 0; i < game.tiles.length; i++){
                //     if(pair.indexOf(game.tiles[i]) == -1){
                //         divs[i].className = 'tile';
                //     }
                //     else{
                //         divs[i].className = 'tileSelected';
                //     }
                // }
            }

			$(function(){	//document is ready
				socket.on('connection acknowledgment',function(wallet,bet,time){
					game.lastStateChange = time;
					game.bet = bet;
					game.minimumBet = bet;
					game.wallet = wallet;
    				$("#messages").prepend("<li>Got a connection from the server</li>");
    				updateGameInfo();
    			});
    			socket.on('bet lock confirm',function(bet){
    				$("#messages").prepend("<li>Server confirms bet lock at $"+bet+"</li>");
    			});
    			socket.on('bet unlock confirm',function(){
    				$("#messages").prepend("<li>Server confirms bet unlock.</li>");
    			});

                // Handle state changes
    			socket.on('game state change',function(state,time){
    				game.state = state;
    				if(state == "dealing" && !game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    				if(state == "pregame"){
    					game.bet = game.minimumBet;
    				}
    				if(state == "tile reveal"){
                        game.selectionLocked = true;
    					if(game.selectedTiles.length != 2 && game.selectionLocked == false){
                            if(game.lastConfirmedSelection.length == 2){
                                //the user had perviously locked with a valid selection, reapply this selection
                                game.selectedTiles = game.lastConfirmedSelection;
                            }
                            else{
                                //the user has not locked anything, and doesn't have two tiles selected. Apply default.
        						game.selectedTiles = [game.tiles[0],game.tiles[1]];
                            }
                            socket.emit('tile selection',game.selectedTiles);
    					}
    					else if(game.selectionLocked == false){
                            //player hasn't locked, but has two tiles highlighted
                            //consider changing this logic, do we want to use the two selected, or the last locked in pair?
                            game.selectedTiles = game.lastConfirmedSelection;
    						socket.emit('tile selection', game.selectedTiles);
    					}
    					else{
    						socket.emit('tile selection', game.selectedTiles);	
    					}
    				}
                    if(state == 'endgame'){
                        resetGameInfo();
                    }
    				game.lastStateChange = time;
    				updateGameInfo();
    				$("#messages").prepend("<li>Game state changed to "+state+"</li>");
    			});

                socket.on('confirm tile selection',function(pair){
                    $("#messages").prepend("<li>Server confirms pair selection: "+pair+"</li>");
                    game.lastConfirmedSelection = pair;
                    //on the confirmation, change the highlighted tiles
                    highlightTiles(pair);
                });

                socket.on('finalize tile selection',function(pair){
                    $("#messages").prepend("<li>Server finalizes pair selection: "+pair+"</li>");
                    highlightTiles(pair);
                });

    			socket.on('player dealt',function(tile){
    				game.tiles.push(tile);
    				if(game.tiles.length == 1){
    					$("#one").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 2){
    					$("#two").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 3){
    					$("#three").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 4){
    					$("#four").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				$("#messages").prepend("<li>Player dealt tile "+tile+"</li>");
    			});
    			socket.on('other player tiles',function(id,tiles,pair){
    				$("#messages").prepend("<li>Player \'"+id+"\' dealt tile "+tiles+" and selected pair "+pair+"</li>");
                    if(id == 'dealer'){
                        game.dealerTiles = tiles;
                    }
    			});
    			socket.on('confirm selection locked',function(pair){
                    game.lastConfirmedSelection = pair;
    				$("#messages").prepend("<li>Server confirms pair locked: "+pair+"</li>");
    			});
    			socket.on('confirm selection unlocked',function(){
    				$("#messages").prepend("<li>Server confirms pair unlocked</li>");
    			});
                socket.on('wallet update',function(wallet){
                   $("#messages").prepend("<li>Wallet update: "+wallet+"</li>");
                   game.wallet = wallet;
                });
                socket.on('match result',function(result){
                    if(result == 'push'){
                        $("#messages").prepend("<li>Matched ended in a push</li>");
                    }
                    if(result == 'banker win'){
                        $("#messages").prepend("<li>Banker win</li>");
                    }
                    if(result == 'opponent win'){
                        $("#messages").prepend("<li>Opponent win</li>");
                    }
                });
                socket.on('pregame game information',function(banker){
                    game.banker = banker;
                });

    			setInterval(function(){
    				updateGameInfo();
    			},50);



				//button click listeners
				$("#lockBet").click(function(){
					if(game.state != "betting"){
						return;
					}
					if(!game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    			});

    			$("#unlockBet").click(function(){
    				if(game.state != "betting"){
    					return;
    				}
    				if(game.betsLocked){
    					game.betsLocked = false;
    					socket.emit("bet unlocked");
    				}
    			});

    			$("#bet5").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+5){
    					game.bet = game.bet+5;
    				}
    				updateGameInfo();
    			});
    			$("#bet10").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+10){
    					game.bet = game.bet+10;
    				}
    				updateGameInfo();
    			});
    			$("#bet25").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+25){
    					game.bet = game.bet+25;
    				}
    				updateGameInfo();
    			});
    			$("#one").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[0]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#two").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[1]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#three").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[2]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#four").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[3]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#lockPair").click(function(){
    				if(game.state == "pair selection" && game.selectedTiles.length == 2 && !game.selectionLocked){
    					game.selectionLocked = true;
    					socket.emit('pair selection locked',game.selectedTiles);
    				}
    			});
    			$("#unlockPair").click(function(){
    				if(game.state == "pair selection" && game.selectionLocked){
    					game.selectionLocked = false;
    					socket.emit('pair selection unlocked');
    				}
    			});

                //Listener for the canvas
                $("#game").click(function(e){
                    var x = Math.floor((e.pageX-$("#game").offset().left));
                    var y = Math.floor((e.pageY-$("#game").offset().top));
                    console.log(x+" "+y);

                    // Bet 5
                    if(x>bet5ButtonInfo[0] && x<bet5ButtonInfo[0]+bet5ButtonInfo[2] && y>bet5ButtonInfo[1] && y < bet5ButtonInfo[1]+bet5ButtonInfo[3]){
                        //the bet 5 button has been clicked
                        if(game.betsLocked || game.state != "betting"){

                        }
                        else if(game.wallet >= game.bet+5){
                            game.bet = game.bet+5;
                        }
                        updateGameInfo();
                    }

                    // Bet lock button
                    if(x>betLockButtonInfo[0] && x<betLockButtonInfo[0]+betLockButtonInfo[2] && y>betLockButtonInfo[1] && y < betLockButtonInfo[1]+betLockButtonInfo[3]){
                        if(game.state == "betting"){
                            console.log(game.betsLocked);
                            if(!game.betsLocked){
                                socket.emit("bet locked",game.bet);
                                game.betsLocked = true;
                            }
                            else{
                                game.betsLocked = false;
                                socket.emit("bet unlocked");
                            }
                        }
                    }

                    // Pair lock button
                   if(x>selectionLockButtonInfo[0] && x<selectionLockButtonInfo[0]+selectionLockButtonInfo[2] && y>selectionLockButtonInfo[1] && y < selectionLockButtonInfo[1]+selectionLockButtonInfo[3]){
                        console.log("Get clicked");
                        if(game.state == "pair selection"){
                            if(!game.selectionLocked){
                                if(game.state == "pair selection" && game.selectedTiles.length == 2 && !game.selectionLocked){
                                    game.selectionLocked = true;
                                    socket.emit('pair selection locked',game.selectedTiles);
                                }
                            }
                            else{
                                if(game.state == "pair selection" && game.selectionLocked){
                                    game.selectionLocked = false;
                                    socket.emit('pair selection unlocked');
                                }
                            }
                        }
                    }

                    for(var i = 0; i < 4; i++){
                        if(x>seatTileLocations[i][0] && x<seatTileLocations[i][0]+tileWidth/2 && y>seatTileLocations[i][1] && y < seatTileLocations[i][1]+tileHeight/2){
                            console.log("clicked on "+i);
                            if(game.state == "pair selection" && !game.selectionLocked){
                                if(game.clickedTiles.indexOf(i) != -1){
                                    var index = game.clickedTiles.indexOf(i);
                                    game.clickedTiles.splice(index,1);
                                    var index = game.clickedTiles.indexOf(game.tiles[i]);
                                    game.selectedTiles.splice(index,1);
                                }
                                else{
                                    game.selectedTiles.push(game.tiles[i]);
                                    game.clickedTiles.push(i);
                                }
                                console.log(game.clickedTiles);
                                console.log(game.selectedTiles);
                            }
                        }
                    }


                });
			});

		</script>

		<div id="container">
			<div id="topbar"></div>
			<div id="leftbar"></div>
			<div id="gamewindow">
    				<!-- <div id="buttons">
    					<div id="betting Buttons">
    						<button id="bet5">Bet $5</button>
    						<button id="bet10">Bet $10</button>
    						<button id="bet25">Bet $25</button>
    						<button id="lockBet">Lock bet</button>
    						<button id="unlockBet">Unlock bet</button>
    					</div>
    					<div id="tileButtons">
    						<button id="lockPair">Lock Selection</button>
    						<button id="unlockPair">Unock Selection</button>
    					</div>
    					<div id="miscButtons">
    						<button id="quit">Quit</button>
    					</div>
    					<div id="gameInformation">
    						
    					</div>
    					<div id="tileSelection">
    						<div class="tile" id='one'>
    						</div>
    						<div class="tile" id='two'>
    						</div>
    						<div class="tile" id='three'>
    						</div>
    						<div class="tile" id='four'>
    						</div>
    					</div>
    				</div> -->

                <canvas id="game"></canvas>

    			<div>
    				<ul id="messages"></ul>
    			</div>

		      </div>
		      <div id="rightbar"></div>
	       </div>

    </body>



</html>