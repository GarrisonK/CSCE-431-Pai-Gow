<html>

	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>

	<title>Pai Gow</title>

	<body>

		<script>

			var dots = [3,6,12,12,2,2,8,8,4,4,10,10,6,6,4,4,11,11,10,10,7,7,6,6,9,9,8,8,7,7,5,5];
			var tileNames = ["Gee Joon","Gee Joon","Teen","Teen","Day","Day","Yun","Yun","Gor","Gor","Mooy","Mooy","Chong","Chong","Bon","Bon","Foo","Foo","Ping","Ping","Tit","Tit","Look","Look","Chop Gow","Chop Gow","Chop Bot","Chop Bot","Chop Chit","Chot Chit","Chop Ng","Chop Ng"];
			var ranks = [1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16];

            var tileDivNames = ["#one","#two","#three","#four"];

			var socket = io.connect();
			var wallet = 0;
			var bet = 0;
			var game = new Object();
			game['wallet'] = 0;
			game['bet'] = 0;
			game['minimumBet'] = 0;
			game['betsLocked'] = false;
			game['state'] = "pregame";
			game['stateChangeTime'] = 5000;
			game['lastStateChange'] = 0;
			game['banker'] = -1;
			game['tiles'] = [];
			game['selectedTiles'] = [];
			game['selectionLocked'] = false;
            game['lastConfirmedSelection'] = []; //the last verified valid selection, is used if the player ends selection phase unlocked

			var updateGameInfo = function(){
                //Prints seconds remaining, game state, etc
				var d = new Date();
				var t = (game.stateChangeTime-(d.getTime()-game.lastStateChange))
				t=t/1000;
				if(t<0){
					t = 0;
				}
				$("#gameInformation").empty();
	    		$("#gameInformation").html("Seconds remaining: "+t+"<br>Game state: "+game.state+"<br>Current bet: $"+game.bet+"<br>Wallet: $"+game.wallet+"<br>Tile selection: "+game.selectedTiles+"<br>Banker: "+game.banker);
			}

            //called to reset all information to begin a new game
            function resetGameInfo(){
                game.bet = game.minimumBet;
                game.betsLocked = false;
                game.tiles = [];
                game. selectedTiles = [];
                game.selectionLocked = false;
                game.lastConfirmedSelection = [];
                resetTileDivs();
            }

            function resetTileDivs(){
                var divs = $('#one, #two, #three, #four');
                for(var i = 0; i < divs.length; i++){
                    divs.eq(i).empty();
                    divs.eq(i).removeClass('tileSelected').addClass('tile');
                }
            }

            //takes a pair and highlights those tiles
            var highlightTiles = function(pair){
                var divs = $('#one, #two, #three, #four');

                for(var i = 0; i < game.tiles.length; i++){
                    if(pair.indexOf(game.tiles[i]) == -1){
                        divs[i].className = 'tile';
                    }
                    else{
                        divs[i].className = 'tileSelected';
                    }
                }
            }

			$(function(){	//document is ready
				socket.on('connection acknowledgment',function(wallet,bet,time){
					game.lastStateChange = time;
					game.bet = bet;
					game.minimumBet = bet;
					game.wallet = wallet;
    				$("#messages").prepend("<li>Got a connection from the server</li>");
    				updateGameInfo();
    			});
    			socket.on('bet lock confirm',function(bet){
    				$("#messages").prepend("<li>Server confirms bet lock at $"+bet+"</li>");
    			});
    			socket.on('bet unlock confirm',function(){
    				$("#messages").prepend("<li>Server confirms bet unlock.</li>");
    			});
    			socket.on('game state change',function(state,time){
    				game.state = state;
    				if(state == "dealing" && !game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    				if(state == "pregame"){
    					game.bet = game.minimumBet;
    				}
    				if(state == "tile reveal"){
    					if(game.selectedTiles.length != 2 && game.selectionLocked == false){
                            if(game.lastConfirmedSelection.length == 2){
                                //the user had perviously locked with a valid selection, reapply this selection
                                game.selectedTiles = game.lastConfirmedSelection;
                            }
                            else{
                                //the user has not locked anything, and doesn't have two tiles selected. Apply default.
        						game.selectedTiles = [game.tiles[0],game.tiles[1]];
                            }
                            socket.emit('tile selection',game.selectedTiles);
    					}
    					else if(game.selectionLocked == false){
                            //player hasn't locked, but has two tiles highlighted
                            //consider changing this logic, do we want to use the two selected, or the last locked in pair?
                            game.selectedTiles = game.lastConfirmedSelection;
    						socket.emit('tile selection', game.selectedTiles);
    					}
    					else{
    						socket.emit('tile selection', game.selectedTiles);	
    					}
    				}
                    if(state == 'endgame'){
                        resetGameInfo();
                    }
    				game.lastStateChange = time;
    				updateGameInfo();
    				$("#messages").prepend("<li>Game state changed to "+state+"</li>");
    			});

                socket.on('confirm tile selection',function(pair){
                    $("#messages").prepend("<li>Server confirms pair selection: "+pair+"</li>");
                    game.lastConfirmedSelection = pair;
                    //on the confirmation, change the highlighted tiles
                    highlightTiles(pair);
                });

                socket.on('finalize tile selection',function(pair){
                    $("#messages").prepend("<li>Server finalizes pair selection: "+pair+"</li>");
                    highlightTiles(pair);
                });

    			socket.on('player dealt',function(tile){
    				game.tiles.push(tile);
    				if(game.tiles.length == 1){
    					$("#one").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 2){
    					$("#two").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 3){
    					$("#three").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				if(game.tiles.length == 4){
    					$("#four").html("id: "+tile+"<br>dots: "+dots[tile]+"<br>name: "+tileNames[tile]+"<br>rank: "+ranks[tile]);
    				}
    				$("#messages").prepend("<li>Player dealt tile "+tile+"</li>");
    			});
    			socket.on('other player tiles',function(id,tiles,pair){
    				$("#messages").prepend("<li>Player \'"+id+"\' dealt tile "+tiles+" and selected pair "+pair+"</li>");
    			});
    			socket.on('confirm selection locked',function(pair){
                    game.lastConfirmedSelection = pair;
    				$("#messages").prepend("<li>Server confirms pair locked: "+pair+"</li>");
    			});
    			socket.on('confirm selection unlocked',function(){
    				$("#messages").prepend("<li>Server confirms pair unlocked</li>");
    			});
                socket.on('wallet update',function(wallet){
                   $("#messages").prepend("<li>Wallet update: "+wallet+"</li>");
                   game.wallet = wallet;
                });
                socket.on('match result',function(result){
                    if(result == 'push'){
                        $("#messages").prepend("<li>Matched ended in a push</li>");
                    }
                    if(result == 'banker win'){
                        $("#messages").prepend("<li>Banker win</li>");
                    }
                    if(result == 'opponent win'){
                        $("#messages").prepend("<li>Opponent win</li>");
                    }
                });
                socket.on('pregame game information',function(banker){
                    game.banker = banker;
                });

    			setInterval(function(){
    				updateGameInfo();
    			},50);



				//button click listeners
				$("#lockBet").click(function(){
					if(game.state != "betting"){
						return;
					}
					if(!game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    			});

    			$("#unlockBet").click(function(){
    				if(game.state != "betting"){
    					return;
    				}
    				if(game.betsLocked){
    					game.betsLocked = false;
    					socket.emit("bet unlocked");
    				}
    			});

    			$("#bet5").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+5){
    					game.bet = game.bet+5;
    				}
    				updateGameInfo();
    			});
    			$("#bet10").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+10){
    					game.bet = game.bet+10;
    				}
    				updateGameInfo();
    			});
    			$("#bet25").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+25){
    					game.bet = game.bet+25;
    				}
    				updateGameInfo();
    			});
    			$("#one").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[0]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#two").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[1]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#three").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[2]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#four").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[3]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#lockPair").click(function(){
    				if(game.state == "pair selection" && game.selectedTiles.length == 2 && !game.selectionLocked){
    					game.selectionLocked = true;
    					socket.emit('pair selection locked',game.selectedTiles);
    				}
    			});
    			$("#unlockPair").click(function(){
    				if(game.state == "pair selection" && game.selectionLocked){
    					game.selectionLocked = false;
    					socket.emit('pair selection unlocked');
    				}
    			});
			});

		</script>

		<div id="container">
			<div id="topbar"></div>
			<div id="leftbar"></div>
			<div id="gamewindow">
				<div id="buttons">
					<div id="betting Buttons">
						<button id="bet5">Bet $5</button>
						<button id="bet10">Bet $10</button>
						<button id="bet25">Bet $25</button>
						<button id="lockBet">Lock bet</button>
						<button id="unlockBet">Unlock bet</button>
					</div>
					<div id="tileButtons">
						<button id="lockPair">Lock Selection</button>
						<button id="unlockPair">Unock Selection</button>
					</div>
					<div id="miscButtons">
						<button id="quit">Quit</button>
					</div>
					<div id="gameInformation">
						
					</div>
					<div id="tileSelection">
						<div class="tile" id='one'>
						</div>
						<div class="tile" id='two'>
						</div>
						<div class="tile" id='three'>
						</div>
						<div class="tile" id='four'>
						</div>
					</div>
				</div>
				<div>
					<ul id="messages">

					</ul>
				</div>

			</div>
			<div id="rightbar"></div>
		</div>

	</body>



</html>