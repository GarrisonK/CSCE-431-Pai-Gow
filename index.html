<html>

	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
        <script type="text/javascript" src="paper.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>

	<title>Pai Gow</title>

	<body>

		<script>

            paper.install(window);




            //Pai Gow tile infomation code
            var dots = [3,6,12,12,2,2,8,8,4,4,10,10,6,6,4,4,11,11,10,10,7,7,6,6,9,9,8,8,7,7,5,5];
            var tileNames = ["Gee Joon","Gee Joon","Teen","Teen","Day","Day","Yun","Yun","Gor","Gor","Mooy","Mooy","Chong","Chong","Bon","Bon","Foo","Foo","Ping","Ping","Tit","Tit","Look","Look","Chop Gow","Chop Gow","Chop Bot","Chop Bot","Chop Chit","Chot Chit","Chop Ng","Chop Ng"];
            var ranks = [1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16];


            //code used for finding the winner of a round

            function getNumDots(id){
                return dots[id];
            }

            function getRank(id){
                return ranks[id];
            }

            function getNonPairValue(id1, id2){
                //returns 0-9 representing value, or -1 if the ids form a pair
                //If one of the tiles is the Gee Joon, returns the better of the two possible values.
                if(isPair(id1,id2)){
                    return -1;
                }
                else{
                    if(getRank(id1) == 1){
                        var val1 = 3+getNumDots(id2);
                        var val2 = 6+getNumDots(id2);
                        if(val1%10 > val2%10){
                            return val1%10;
                        }
                        return val2%10;
                    }
                    else if(getRank(id2) == 1){
                        var val1 = 3+getNumDots(id1);
                        var val2 = 6+getNumDots(id1);
                        if(val1%10 > val2%10){
                            return val1%10;
                        }
                        return val2%10;
                    }
                    else{
                        var val = getNumDots(id1)+getNumDots(id2);
                        return val%10;
                    }
                }
            }

            function isPair(id1, id2){
                if(getRank(id1) == getRank(id2)){
                    return true;
                }
                return false;
            }

            function isWong(id1, id2){
                if(getRank(id1) == 2 && getNumDots(id2) == 9){
                    return true;
                }
                if(getRank(id1) == 3 && getNumDots(id2) == 9){
                    return true;
                }
                if(getRank(id2) == 2 && getNumDots(id1) == 9){
                    return true;
                }
                if(getRank(id2) == 3 && getNumDots(id1) == 9){
                    return true;
                }
                return false;
            }

            function isGong(id1, id2){
                if(getRank(id1) == 2 && getNumDots(id2) == 8){
                    return true;
                }
                if(getRank(id1) == 3 && getNumDots(id2) == 8){
                    return true;
                }
                if(getRank(id2) == 2 && getNumDots(id1) == 8){
                    return true;
                }
                if(getRank(id2) == 3 && getNumDots(id1) == 8){
                    return true;
                }
                return false;
            }

            function getHighestRank(id1, id2){
                //considers the rule that a Gee Joon outside of a pair is the lowest ranking tile possible for tie breaking
                if(getRank(id1) == 1){
                    return getRank(id2);
                }
                else if(getRank(id2) == 1){
                    return getRank(id1);
                }
                else if(getRank(id1) < getRank(id2)){
                    return getRank(id1);
                }
                return getRank(id2);
            }

            function getWinner(id1, id2, id3, id4){
                //Returns 1 if the first set wins, 2 if the second set wins, or -1 if there is a tie

                if(isPair(id1,id2) && !isPair(id3,id4)){
                    return 1;
                }
                if(!isPair(id1,id2) && isPair(id3,id4)){
                    return 2;
                }
                if(isPair(id1,id2) && isPair(id3,id4)){
                    if(getRank(id1) < getRank(id3)) return 1;
                    else return 2;
                }

                //neither is a pair

                if((isWong(id1,id2) && isWong(id3,id4)) || (isGong(id1,id2) && isGong(id3,id4))){
                    var highestRank1 = getHighestRank(id1,id2);
                    var highestRank2 = getHighestRank(id3,id4);
                    if(highestRank1 < highestRank2){
                        return 1;
                    }
                    else{
                        return 2;
                    }
                }
                else if(isWong(id1,id2)){
                    return 1;
                }
                else if(isWong(id3,id4)){
                    return 2;
                }
                else if(isGong(id1,id2)){
                    return 1;
                }
                else if(isGong(id3,id4)){
                    return 2;
                }

                //Neither is a pair or Wong/Gong
                var val1 = getNonPairValue(id1,id2);
                var val2 = getNonPairValue(id3,id4);

                if(val1>val2) return 1;
                else if(val2>val1) return 2;
                else{
                    if(val1 == 0 && val2 == 0) return -1;
                    var highestRank1 = getHighestRank(id1,id2);
                    var highestRank2 = getHighestRank(id3,id4);

                    if(highestRank1 < highestRank2){
                        return 1;
                    }
                    else if(highestRank2 < highestRank1){
                        return 2;
                    }
                    else return -1;


                }
            }

            function getOtherPair(tiles,selection){
                //returns the second pair
                //ex: tiles = [0,1,2,3], selection = [1,2]
                //will return [0,3]
                var pair = [];
                for(var i = 0; i < tiles.length; i++){
                    if(selection.indexOf(tiles[i]) == -1){
                        pair.push(tiles[i]);
                    }
                }
                return pair;
            }

            function getBestPairSelection(tiles){
                //will return a pair of values
                //TODO Write better code

                if(isPair(tiles[0],tiles[1])){
                    return [tiles[0],tiles[1]];
                }
                if(isPair(tiles[0],tiles[2])){
                    return [tiles[0],tiles[2]];
                }
                if(isPair(tiles[0],tiles[3])){
                    return [tiles[0],tiles[3]];
                }
                if(isPair(tiles[1],tiles[2])){
                    return [tiles[1],tiles[2]];
                }
                if(isPair(tiles[1],tiles[3])){
                    return [tiles[1],tiles[3]];
                }
                if(isPair(tiles[2],tiles[3])){
                    return [tiles[2],tiles[3]];
                }

                if(isWong(tiles[0],tiles[1])){
                    return [tiles[0],tiles[1]];
                }
                if(isWong(tiles[0],tiles[2])){
                    return [tiles[0],tiles[2]];
                }
                if(isWong(tiles[0],tiles[3])){
                    return [tiles[0],tiles[3]];
                }
                if(isWong(tiles[1],tiles[2])){
                    return [tiles[1],tiles[2]];
                }
                if(isWong(tiles[1],tiles[3])){
                    return [tiles[1],tiles[3]];
                }
                if(isWong(tiles[2],tiles[3])){
                    return [tiles[2],tiles[3]];
                }

                if(isGong(tiles[0],tiles[1])){
                    return [tiles[0],tiles[1]];
                }
                if(isGong(tiles[0],tiles[2])){
                    return [tiles[0],tiles[2]];
                }
                if(isGong(tiles[0],tiles[3])){
                    return [tiles[0],tiles[3]];
                }
                if(isGong(tiles[1],tiles[2])){
                    return [tiles[1],tiles[2]];
                }
                if(isGong(tiles[1],tiles[3])){
                    return [tiles[1],tiles[3]];
                }
                if(isGong(tiles[2],tiles[3])){
                    return [tiles[2],tiles[3]];
                }

                var p1 = getNonPairValue(tiles[0],tiles[1]);
                var p2 = getNonPairValue(tiles[0],tiles[2]);
                var p3 = getNonPairValue(tiles[0],tiles[3]);
                var p4 = getNonPairValue(tiles[1],tiles[2]);
                var p5 = getNonPairValue(tiles[1],tiles[3]);
                var p6 = getNonPairValue(tiles[2],tiles[3]);

                if(p1 >= p2 && p1 >= p3 && p1 >= p4 && p1 >= p5 && p1 >= p6){
                    return [tiles[0],tiles[1]];
                }
                if(p2 >= p1 && p2 >= p3 && p2 >= p4 && p2 >= p5 && p2 >= p6){
                    return [tiles[0],tiles[2]];
                }
                if(p3 >= p2 && p3 >= p1 && p3 >= p4 && p3 >= p5 && p3 >= p6){
                    return [tiles[0],tiles[3]];
                }
                if(p4 >= p2 && p4 >= p3 && p4 >= p1 && p4 >= p5 && p4 >= p6){
                    return [tiles[1],tiles[2]];
                }
                if(p5 >= p2 && p5 >= p3 && p5 >= p4 && p5 >= p1 && p5 >= p6){
                    return [tiles[1],tiles[3]];
                }
                if(p6 >= p2 && p6 >= p3 && p6 >= p4 && p6 >= p5 && p6 >= p1){
                    return [tiles[2],tiles[3]];
                }

                var p1 = getHighestRank(tiles[0],tiles[1]);
                var p2 = getHighestRank(tiles[0],tiles[2]);
                var p3 = getHighestRank(tiles[0],tiles[3]);
                var p4 = getHighestRank(tiles[1],tiles[2]);
                var p5 = getHighestRank(tiles[1],tiles[3]);
                var p6 = getHighestRank(tiles[2],tiles[3]);

                if(p1 >= p2 && p1 >= p3 && p1 >= p4 && p1 >= p5 && p1 >= p6){
                    return [tiles[0],tiles[1]];
                }
                if(p2 >= p1 && p2 >= p3 && p2 >= p4 && p2 >= p5 && p2 >= p6){
                    return [tiles[0],tiles[2]];
                }
                if(p3 >= p2 && p3 >= p1 && p3 >= p4 && p3 >= p5 && p3 >= p6){
                    return [tiles[0],tiles[3]];
                }
                if(p4 >= p2 && p4 >= p3 && p4 >= p1 && p4 >= p5 && p4 >= p6){
                    return [tiles[1],tiles[2]];
                }
                if(p5 >= p2 && p5 >= p3 && p5 >= p4 && p5 >= p1 && p5 >= p6){
                    return [tiles[1],tiles[3]];
                }
                if(p6 >= p2 && p6 >= p3 && p6 >= p4 && p6 >= p5 && p6 >= p1){
                    return [tiles[2],tiles[3]];
                }






                return [tiles[0],tiles[1]];

            }

            function getRoundWinner(bankerTiles, bankerSelection, opTiles, opSelection){
                //returns 1 if 1 wins, 2 if 2 wins, -1 if push
                //tiles1 is assumed to be the banker (winner of ties)

                bankerOther = getOtherPair(bankerTiles,bankerSelection);
                opOther = getOtherPair(opTiles,opSelection);

                bankerHigh = [];
                bankerLow = [];
                opHigh = [];
                opLow = [];

                if(getWinner(bankerSelection[0],bankerSelection[1],bankerOther[0],bankerOther[1]) == 1){
                    bankerHigh = bankerSelection;
                    bankerLow = bankerOther;
                }
                else{
                    bankerHigh = bankerOther;
                    bankerLow = bankerSelection;
                }

                if(getWinner(opSelection[0],opSelection[1],opOther[0],opSelection[1]) == 1){
                    opHigh = opSelection;
                    opLow = opOther;
                }
                else{
                    opHigh = opOther;
                    opLow = opSelection;
                }

                //compare highs
                var result = 0;
                var highWinner = getWinner(bankerHigh[0],bankerHigh[1],opHigh[0],opHigh[1]);
                if(highWinner == 1){
                    result += 1;
                }
                else if(highWinner == 2){
                    result -= 1;
                }
                else{
                    //tie, banker wins
                    result += 1;
                }

                var lowWinner = getWinner(bankerLow[0],bankerLow[1],opLow[0],opLow[1]);
                if(lowWinner == 1){
                    result += 1;
                }
                else if(lowWinner == 2){
                    result -= 1;
                }
                else{
                    //tie, banker wins
                    result +=1;
                }

                if(result == 2){
                    //banker wins, return 1
                    return 1;
                }
                else if(result == -2){
                    //opponent wins, return 2
                    return 2;
                }
                else{
                    // either 1 or -1, indicating neither player won both matches. Push, return -1
                    return -1;
                }
            }









            var tileWidth = 75;
            var tileHeight = 150;
            var tileScale = .5;
            var bet5ButtonInfo = [50,500,50,25];
            var betLockButtonInfo = [50,400,50,25];
            var selectionLockButtonInfo = [50,450,50,25];
            var bankerSelectionInfo = [1000,500,50,25];
            var dealerBankerSymbolLocation = [550,25];
            var bankerSymbolLocations = [[78,156],[117,319],[270,431],[487,459],[718,457],[893,352],[1018,156]];

            var tileLocations = [[665,545],[750,545],[98,72],[182,72],[286,72],[370,72],[478,74],[562,74],[666,74],[750,74],[97,229],[181,229],[285,229],[369,229],[477,231],[561,231],[655,231],[749,231],[96,386],[180,386],[284,386],[368,386],[476,388],[560,388],[664,388],[748,388],[96,543],[180,543],[284,543],[368,543],[476,545],[560,545]];

            var dealerTileLocations = [[400,90],[400+1*(tileWidth*tileScale+5),90],[400+2*(tileWidth*tileScale+5),90],[400+3*(tileWidth*tileScale+5),90]];
            // var seatTileLocations = [[400,450],[400+1*(tileWidth*tileScale+5),450],[400+2*(tileWidth*tileScale+5),450],[400+3*(tileWidth*tileScale+5),450]];

            var seatTileLocations = [[[35,206],[35+1*(tileWidth*tileScale+5),206],[35+2*(tileWidth*tileScale+5),206],[35+3*(tileWidth*tileScale+5),206]],
                [[66,362],[66+1*(tileWidth*tileScale+5),362],[66+2*(tileWidth*tileScale+5),362],[66+3*(tileWidth*tileScale+5),362]],
                [[198,472],[198+1*(tileWidth*tileScale+5),472],[198+2*(tileWidth*tileScale+5),472],[198+3*(tileWidth*tileScale+5),472]],
                [[430,500],[430+1*(tileWidth*tileScale+5),500],[430+2*(tileWidth*tileScale+5),500],[430+3*(tileWidth*tileScale+5),500]],
                [[662,498],[662+1*(tileWidth*tileScale+5),498],[662+2*(tileWidth*tileScale+5),498],[662+3*(tileWidth*tileScale+5),498]],
                [[844,398],[844+1*(tileWidth*tileScale+5),398],[844+2*(tileWidth*tileScale+5),398],[844+3*(tileWidth*tileScale+5),398]],
                [[900,214],[900+1*(tileWidth*tileScale+5),214],[900+2*(tileWidth*tileScale+5),214],[900+3*(tileWidth*tileScale+5),214]]
            ];

            var tileX = 75;
            var tileY = 150;

            $(function(){

                paper.setup('game');

                var c = document.getElementById("game");
                var ctx = c.getContext('2d');
                // ctx.fillStyle = "#003300";
                // ctx.fillRect(0,0,150,75);

                // var path;
                // function onMouseDown(event){
                //     path = new Path();
                //     path.strokeColor = "black";
                //     path.add(event.point);
                // }

                // var tool = new Tool();
                // tool.onMouseDown = onMouseDown;
                // tool.onMouseDrag = function(event){
                //     path.add(event.point);
                // }

                // view.onFrame = function(event){
                //     // console.log("test");
                //     ctx.fillStyle = "#003300";
                //     ctx.fill();
                // };

                var tileImage = new Image();
                var tileReady = false;
                tileImage.src = "/tiles.png";
                tileImage.onload = function(){
                    tileReady = true;
                }

                drawTile = function(id,x,y){
                    ctx.drawImage(tileImage,tileLocations[id][0],tileLocations[id][1],tileWidth,tileHeight,x,y,tileWidth*tileScale,tileHeight*tileScale);
                }

                drawPlayerTiles = function(){
                    // if(game.state == "dealing" || game.state == "pair selection" || game.state == "tile reveal"){
                    //     drawTile(game.tiles[0],seatTileLocations[game.seat][0][0],seatTileLocations[game.seat][0][1]);
                    //     drawTile(game.tiles[1],seatTileLocations[game.seat][1][0],seatTileLocations[game.seat][1][1]);
                    //     drawTile(game.tiles[2],seatTileLocations[game.seat][2][0],seatTileLocations[game.seat][2][1]);
                    //     drawTile(game.tiles[3],seatTileLocations[game.seat][3][0],seatTileLocations[game.seat][3][1]);
                    // }

                    //draw all the other player's tiles
                    // console.log(game.seatsTiles);

                    if(game.state == "dealing" || game.state == "pair selection"){
                        for(var j = 0; j < 4; j++){
                            drawTile(game.tiles[j],seatTileLocations[game.seat][j][0],seatTileLocations[game.seat][j][1]);
                        }
                        for(var i = 0; i < 7; i++){
                            if(game.occupiedSeats[i] != 0 && i != game.seat){
                                for(var j = 0; j < 4; j++){
                                    drawTileBack(seatTileLocations[i][j][0],seatTileLocations[i][j][1]);
                                }
                            }
                        }
                    }

                    if(game.state == "tile reveal"){
                        for(var i = 0; i < 7; i++){
                            if(game.seatsTiles[i] != null){
                                for(var j = 0; j < 4; j++){
                                    drawTile(game.seatsTiles[i][j],seatTileLocations[i][j][0],seatTileLocations[i][j][1]);
                                }
                            }
                        }
                    }
                }

                drawDealerTiles = function(){
                    if(game.state == "dealing" || game.state == "pair selection"){
                        drawTileBack(dealerTileLocations[0][0],dealerTileLocations[0][1]);
                        drawTileBack(dealerTileLocations[1][0],dealerTileLocations[1][1]);
                        drawTileBack(dealerTileLocations[2][0],dealerTileLocations[2][1]);
                        drawTileBack(dealerTileLocations[3][0],dealerTileLocations[3][1]);
                    }
                    else if(game.state == 'tile reveal'){
                        drawTile(game.dealerTiles[0],dealerTileLocations[0][0],dealerTileLocations[0][1]);
                        drawTile(game.dealerTiles[1],dealerTileLocations[1][0],dealerTileLocations[1][1]);
                        drawTile(game.dealerTiles[2],dealerTileLocations[2][0],dealerTileLocations[2][1]);
                        drawTile(game.dealerTiles[3],dealerTileLocations[3][0],dealerTileLocations[3][1]);
                    }
                }


                drawBankerSymbol = function(){
                    
                    //draw the white banker symbol at appropriate location
                    var position = [0,0];
                    if(game.banker == -1){
                        position = dealerBankerSymbolLocation;
                    }
                    else{
                        position = bankerSymbolLocations[game.banker];
                    }
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(position[0],position[1],20,20);

                    //also draw the selection box for banking on players turn
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(bankerSelectionInfo[0],bankerSelectionInfo[1],bankerSelectionInfo[2],bankerSelectionInfo[3]);
                    if(game.bankOnTurn){
                        ctx.fillStyle = "#00FF00";
                        ctx.fillText("Bank",bankerSelectionInfo[0],bankerSelectionInfo[1]);
                    }
                    else{
                        ctx.fillStyle = "#CC0000";
                        ctx.fillText("Skip",bankerSelectionInfo[0],bankerSelectionInfo[1]);
                    }
                }

                drawTileBack = function(x,y){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(x,y,tileWidth*tileScale,tileHeight*tileScale);
                }

                drawBettingButtons = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(bet5ButtonInfo[0],bet5ButtonInfo[1],bet5ButtonInfo[2],bet5ButtonInfo[3]);
                }

                drawSelectionLockButtons = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(selectionLockButtonInfo[0],selectionLockButtonInfo[1],selectionLockButtonInfo[2],selectionLockButtonInfo[3]);
                    if(game.selectionLocked){
                        ctx.fillStyle = "#FF0000";
                        ctx.fillText("LOCKED",selectionLockButtonInfo[0],selectionLockButtonInfo[1]);
                    }
                    else{
                        ctx.fillStyle = "#006600";
                        ctx.fillText("UNLOCKED",selectionLockButtonInfo[0],selectionLockButtonInfo[1]);
                    }
                }

                drawBetLockButton = function(){
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(betLockButtonInfo[0],betLockButtonInfo[1],betLockButtonInfo[2],betLockButtonInfo[3]);
                    if(game.betsLocked){
                        ctx.fillStyle = "#FF0000";
                        ctx.fillText("LOCKED",betLockButtonInfo[0],betLockButtonInfo[1]);
                    }
                    else{
                        ctx.fillStyle = "#006600";
                        ctx.fillText("UNLOCKED",betLockButtonInfo[0],betLockButtonInfo[1]);
                    }

                }

                drawWagers = function(){
                    ctx.fillStyle = "#000000";
                    ctx.font = '20pt Calibri';
                    ctx.fillText("Wager: "+game.bet,c.width/2,400);
                    ctx.fillText("Dealer wager: "+game.minimumBet,c.width/2,200);
                }

                //takes a pair and highlights those tiles
                var highlightTiles = function(pair){

                    for(var i = 0; i < game.tiles.length; i++){
                        if(pair.indexOf(game.tiles[i]) != -1){
                            //tile is selected
                            ctx.fillRect(seatTileLocations[game.seat][i][0]+25,seatTileLocations[game.seat][i][1]-25,10,10);
                        }
                    }
                }

                // highlights the current selection (Not confirmed by server)
                var highlightSelection = function(){
                    ctx.fillStyle = "#FFFF00"; //yellow
                    for(var i = 0; i < game.tiles.length; i++){
                        if(game.selectedTiles.indexOf(game.tiles[i]) != -1){
                            //tile is selected
                            ctx.fillRect(seatTileLocations[game.seat][i][0]+25,seatTileLocations[game.seat][i][1]-25,10,10);
                        }
                    }   
                }

                var highlightDealerSelection = function(){
                    ctx.fillStyle = "#FFFF00";
                    for(var i = 0; i < game.dealerTiles.length; i++){
                        if(game.dealerSelection.indexOf(game.dealerTiles[i]) != -1){
                            ctx.fillRect(dealerTileLocations[i][0]+25,dealerTileLocations[i][1]-25,10,10);
                        }
                    }
                }

                var drawTimer = function(){
                    var d = new Date();
                    var t = (game.stateChangeTime-(d.getTime()-game.lastStateChange))
                    t=t/1000;
                    if(t<0){
                        t = 0;
                    }

                    ctx.fillStyle = "#000000";
                    ctx.fillText(t,1000,50);
                }

                var drawPlayerPairHelp = function(){
                    var text = "";
                    if(game.selectedTiles.length == 2){
                        if(isPair(game.selectedTiles[0],game.selectedTiles[1])){
                            text+="Pair";
                        }
                        else if(isWong(game.selectedTiles[0],game.selectedTiles[1])){
                            text+="Wong";
                        }
                        else if(isGong(game.selectedTiles[0],game.selectedTiles[1])){
                            text+="Gong"
                        }
                        else{
                            text+=getNonPairValue(game.selectedTiles[0],game.selectedTiles[1]);
                        }

                        var other = getOtherPair(game.tiles,game.selectedTiles);

                        text+="/";

                        if(isPair(other[0],other[1])){
                            text+="Pair";
                        }
                        else if(isWong(other[0],other[1])){
                            text+="Wong";
                        }
                        else if(isGong(other[0],other[1])){
                            text+="Gong"
                        }
                        else{
                            text+=getNonPairValue(other[0],other[1]);
                        }

                        ctx.fillStyle = "#000000";
                        ctx.fillText(text,seatTileLocations[game.seat][1][0],seatTileLocations[game.seat][1][1]+tileHeight*tileScale+25);
                    }
                }

                var drawDealerPairHelp = function(){
                    var text = "";
                    if(game.dealerSelection.length == 2){
                        if(isPair(game.dealerSelection[0],game.dealerSelection[1])){
                            text+="Pair";
                        }
                        else if(isWong(game.dealerSelection[0],game.dealerSelection[1])){
                            text+="Wong";
                        }
                        else if(isGong(game.dealerSelection[0],game.dealerSelection[1])){
                            text+="Gong"
                        }
                        else{
                            text+=getNonPairValue(game.dealerSelection[0],game.dealerSelection[1]);
                        }

                        var other = getOtherPair(game.dealerTiles,game.dealerSelection);

                        text+="/";

                        if(isPair(other[0],other[1])){
                            text+="Pair";
                        }
                        else if(isWong(other[0],other[1])){
                            text+="Wong";
                        }
                        else if(isGong(other[0],other[1])){
                            text+="Gong"
                        }
                        else{
                            text+=getNonPairValue(other[0],other[1]);
                        }

                        ctx.fillStyle = "#000000";
                        ctx.fillText(text,dealerTileLocations[3][0],dealerTileLocations[3][1]-25);
                    }
                }

                render = function(){
                    
                    //Fill background
                    ctx.fillStyle = "#003300";
                    ctx.fillRect(0,0,c.width,c.height);

                    //Draw pot
                    ctx.fillStyle = "#000000";
                    ctx.beginPath();
                    ctx.arc(c.width/2,c.height/2,50,0,2*Math.PI);
                    ctx.stroke();

                    //Draw game state
                    ctx.fillText("State: "+game.state,20,20);

                    drawBetLockButton();

                    ctx.fillStyle = "#000000";
                    ctx.fillText("Wallet: "+game.wallet,0,c.height);

                    highlightSelection();
                    highlightDealerSelection();

                    drawBankerSymbol();

                    // if(game.banker == -1){
                    //     drawBankerSymbol(500,30);
                    // }
                    // else{
                    //     drawBankerSymbol(500,550);
                    // }

                    if(tileReady){
                        drawPlayerTiles();
                        drawDealerTiles();

                    }
                    // drawTileBack(50,50);
                    drawWagers();
                    drawBettingButtons();
                    drawSelectionLockButtons();

                    if(!game.playerActive){
                        ctx.fillStyle = "#000000";
                        ctx.font = "30px Arial";
                        ctx.fillText("INSUFFICIENT FUNDS",450,350);
                    }

                    drawTimer();
                    drawPlayerPairHelp();
                    drawDealerPairHelp();
                }

                setInterval(function(){
                    render();
                },100)
                // paper.view.draw();
            });

			var dots = [3,6,12,12,2,2,8,8,4,4,10,10,6,6,4,4,11,11,10,10,7,7,6,6,9,9,8,8,7,7,5,5];
			var tileNames = ["Gee Joon","Gee Joon","Teen","Teen","Day","Day","Yun","Yun","Gor","Gor","Mooy","Mooy","Chong","Chong","Bon","Bon","Foo","Foo","Ping","Ping","Tit","Tit","Look","Look","Chop Gow","Chop Gow","Chop Bot","Chop Bot","Chop Chit","Chot Chit","Chop Ng","Chop Ng"];
			var ranks = [1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,14,14,15,15,16,16];

            var tileDivNames = ["#one","#two","#three","#four"];

			var socket = io.connect();
			var wallet = 0;
			var bet = 0;
			var game = new Object();
			game['wallet'] = 0;
			game['bet'] = 0;
			game['minimumBet'] = 0;
			game['betsLocked'] = false;
			game['state'] = "pregame";
			game['stateChangeTime'] = 5000;
			game['lastStateChange'] = 0;
			game['banker'] = -1;
			game['tiles'] = [];
			game['selectedTiles'] = [];
			game['selectionLocked'] = false;
            game['clickedTiles'] = [];  //Contains the index 0-3 of the tile that was clicked
            game['lastConfirmedSelection'] = []; //the last verified valid selection, is used if the player ends selection phase unlocked
            game['dealerTiles'] = [];
            game['dealerSelection'] = [];
            game['bankOnTurn'] = true; //whether the player elects to bank or not
            game['playerActive'] = true;
            game['seat'] = 0;
            game['occupiedSeats'] = [];
            game['seatsTiles'] = []; //contains the tiles dealt to each seat
            game['seatsPairs'] = [];

			var updateGameInfo = function(){
                //Prints seconds remaining, game state, etc
				var d = new Date();
				var t = (game.stateChangeTime-(d.getTime()-game.lastStateChange))
				t=t/1000;
				if(t<0){
					t = 0;
				}
				$("#gameInformation").empty();
	    		$("#gameInformation").html("Seconds remaining: "+t+"<br>Game state: "+game.state+"<br>Current bet: $"+game.bet+"<br>Wallet: $"+game.wallet+"<br>Tile selection: "+game.selectedTiles+"<br>Banker: "+game.banker);

			}

            //called to reset all information to begin a new game
            function resetGameInfo(){
                game.bet = game.minimumBet;
                game.betsLocked = false;
                game.tiles = [];
                game.selectedTiles = [];
                game.selectionLocked = false;
                game.lastConfirmedSelection = [];
                game.dealerTiles = [];
                // resetTileDivs();
                game.clickedTiles = [];
                game.dealerSelection = [];
            }

            function resetTileDivs(){
                var divs = $('#one, #two, #three, #four');
                for(var i = 0; i < divs.length; i++){
                    divs.eq(i).empty();
                    divs.eq(i).removeClass('tileSelected').addClass('tile');
                }
            }

			$(function(){	//document is ready
				socket.on('connection acknowledgment',function(wallet,bet,time,banker,seat){
					game.lastStateChange = time;
					game.bet = bet;
					game.minimumBet = bet;
					game.wallet = wallet;
                    game.banker = banker;
                    game.seat = seat;
    				$("#messages").prepend("<li>Got a connection from the server</li>");
    				updateGameInfo();
    			});
    			socket.on('bet lock confirm',function(bet){
    				$("#messages").prepend("<li>Server confirms bet lock at $"+bet+"</li>");
    			});
    			socket.on('bet unlock confirm',function(){
    				$("#messages").prepend("<li>Server confirms bet unlock.</li>");
    			});

                // Handle state changes
    			socket.on('game state change',function(state,time){
    				game.state = state;
    				if(state == "dealing" && !game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    				if(state == "pregame"){
    					game.bet = game.minimumBet;
    				}
    				if(state == "tile reveal"){
                        game.selectionLocked = true;
    					if(game.selectedTiles.length != 2 && game.selectionLocked == false){
                            if(game.lastConfirmedSelection.length == 2){
                                //the user had perviously locked with a valid selection, reapply this selection
                                game.selectedTiles = game.lastConfirmedSelection;
                            }
                            else{
                                //the user has not locked anything, and doesn't have two tiles selected. Apply default.
        						game.selectedTiles = [game.tiles[0],game.tiles[1]];
                            }
                            socket.emit('tile selection',game.selectedTiles);
    					}
    					else if(game.selectionLocked == false){
                            //player hasn't locked, but has two tiles highlighted
                            //consider changing this logic, do we want to use the two selected, or the last locked in pair?
                            game.selectedTiles = game.lastConfirmedSelection;
    						socket.emit('tile selection', game.selectedTiles);
    					}
    					else{
    						socket.emit('tile selection', game.selectedTiles);	
    					}
    				}
                    if(state == 'endgame'){
                        resetGameInfo();
                    }
    				game.lastStateChange = time;
    				updateGameInfo();
    				$("#messages").prepend("<li>Game state changed to "+state+"</li>");
    			});

                socket.on('confirm tile selection',function(pair){
                    $("#messages").prepend("<li>Server confirms pair selection: "+pair+"</li>");
                    game.lastConfirmedSelection = pair;
                    //on the confirmation, change the highlighted tiles
                });

                socket.on('finalize tile selection',function(pair){
                    $("#messages").prepend("<li>Server finalizes pair selection: "+pair+"</li>");
                    game.lastConfirmedSelection = pair;
                    game.selectedTiles = pair;
                });

    			socket.on('player dealt',function(tile){
    				game.tiles.push(tile);
    				$("#messages").prepend("<li>Player dealt tile "+tile+"</li>");
    			});
    			socket.on('other player tiles',function(id,tiles,pair){
    				$("#messages").prepend("<li>Player \'"+id+"\' dealt tile "+tiles+" and selected pair "+pair+"</li>");
                    if(id == 'dealer'){
                        game.dealerTiles = tiles;
                        game.dealerSelection = pair;
                    }
                    else{
                        // console.log(game.occupiedSeats);
                        for(var i = 0; i < 7; i++){
                            if(game.occupiedSeats[i] == id){
                                game.seatsTiles[i] = tiles;
                            }
                        }
                    }

                    // console.log(game.seatsTiles);
                    // TODO add code for different players
    			});
    			socket.on('confirm selection locked',function(pair){
                    game.lastConfirmedSelection = pair;
    				$("#messages").prepend("<li>Server confirms pair locked: "+pair+"</li>");
    			});
    			socket.on('confirm selection unlocked',function(){
    				$("#messages").prepend("<li>Server confirms pair unlocked</li>");
    			});
                socket.on('wallet update',function(wallet){
                   $("#messages").prepend("<li>Wallet update: "+wallet+"</li>");
                   game.wallet = wallet;
                });
                socket.on('match result',function(result){
                    if(result == 'push'){
                        $("#messages").prepend("<li>Matched ended in a push</li>");
                    }
                    if(result == 'banker win'){
                        $("#messages").prepend("<li>Banker win</li>");
                    }
                    if(result == 'opponent win'){
                        $("#messages").prepend("<li>Opponent win</li>");
                    }
                });
                // Information about the game from the server
                socket.on('pregame game information',function(banker){
                    game.banker = banker;
                });
                // Server informs client that he doesnt have enough money to continue
                socket.on('insufficient funds',function(){
                    game.playerActive = false;
                });
                // Server informs client of a connection or disconnection
                socket.on('occupied seats',function(occupied){
                    game.occupiedSeats = occupied;
                });

    			setInterval(function(){
    				updateGameInfo();
    			},50);



				//button click listeners
				$("#lockBet").click(function(){
					if(game.state != "betting"){
						return;
					}
					if(!game.betsLocked){
    					socket.emit("bet locked",game.bet);
    					game.betsLocked = true;
    				}
    			});

    			$("#unlockBet").click(function(){
    				if(game.state != "betting"){
    					return;
    				}
    				if(game.betsLocked){
    					game.betsLocked = false;
    					socket.emit("bet unlocked");
    				}
    			});

    			$("#bet5").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+5){
    					game.bet = game.bet+5;
    				}
    				updateGameInfo();
    			});
    			$("#bet10").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+10){
    					game.bet = game.bet+10;
    				}
    				updateGameInfo();
    			});
    			$("#bet25").click(function(){
    				if(game.betsLocked || game.state != "betting"){
    					return;
    				}
    				if(game.wallet >= game.bet+25){
    					game.bet = game.bet+25;
    				}
    				updateGameInfo();
    			});
    			$("#one").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[0]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#two").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[1]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#three").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[2]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#four").click(function(){
    				if(game.state == "pair selection" && !game.selectionLocked){
    					$(this).toggleClass("tileSelected");
    					if($(this).attr('class') == "tile tileSelected"){
    						game.selectedTiles.push(game.tiles[3]);
    					}
    					else{
    						game.selectedTiles.splice(0,1);
    					}
    				}
    			});
    			$("#lockPair").click(function(){
    				if(game.state == "pair selection" && game.selectedTiles.length == 2 && !game.selectionLocked){
    					game.selectionLocked = true;
    					socket.emit('pair selection locked',game.selectedTiles);
    				}
    			});
    			$("#unlockPair").click(function(){
    				if(game.state == "pair selection" && game.selectionLocked){
    					game.selectionLocked = false;
    					socket.emit('pair selection unlocked');
    				}
    			});

                //Listener for the canvas
                $("#game").click(function(e){
                    var x = Math.floor((e.pageX-$("#game").offset().left));
                    var y = Math.floor((e.pageY-$("#game").offset().top));
                    console.log(x+" "+y);

                    // Bet 5
                    if(x>bet5ButtonInfo[0] && x<bet5ButtonInfo[0]+bet5ButtonInfo[2] && y>bet5ButtonInfo[1] && y < bet5ButtonInfo[1]+bet5ButtonInfo[3]){
                        //the bet 5 button has been clicked
                        console.log("bet 5 button clicked");
                        if(game.betsLocked || game.state != "betting" || game.banker == game.seat){
                            //do nothing
                        }
                        else if(game.wallet >= game.bet+5){
                            game.bet = game.bet+5;
                        }
                        updateGameInfo();
                    }

                    // Bet lock button
                    if(x>betLockButtonInfo[0] && x<betLockButtonInfo[0]+betLockButtonInfo[2] && y>betLockButtonInfo[1] && y < betLockButtonInfo[1]+betLockButtonInfo[3]){
                        if(game.state == "betting" && game.banker != game.seat){
                            console.log(game.betsLocked);
                            if(!game.betsLocked){
                                socket.emit("bet locked",game.bet);
                                game.betsLocked = true;
                            }
                            else{
                                game.betsLocked = false;
                                socket.emit("bet unlocked");
                            }
                        }
                    }

                    // Pair lock button
                   if(x>selectionLockButtonInfo[0] && x<selectionLockButtonInfo[0]+selectionLockButtonInfo[2] && y>selectionLockButtonInfo[1] && y < selectionLockButtonInfo[1]+selectionLockButtonInfo[3]){
                        console.log("Get clicked");
                        if(game.state == "pair selection"){
                            if(!game.selectionLocked){
                                if(game.state == "pair selection" && game.selectedTiles.length == 2 && !game.selectionLocked){
                                    game.selectionLocked = true;
                                    socket.emit('pair selection locked',game.selectedTiles);
                                }
                            }
                            else{
                                if(game.state == "pair selection" && game.selectionLocked){
                                    game.selectionLocked = false;
                                    socket.emit('pair selection unlocked');
                                }
                            }
                        }
                    }

                    // Clicking on tiles
                    for(var i = 0; i < 4; i++){
                        if(x>seatTileLocations[game.seat][i][0] && x<seatTileLocations[game.seat][i][0]+tileWidth*tileScale && y>seatTileLocations[game.seat][i][1] && y < seatTileLocations[game.seat][i][1]+tileHeight*tileScale){
                            console.log("clicked on "+i);
                            if(game.state == "pair selection" && !game.selectionLocked){
                                // Tile i was clicked on and its state should flip
                                if(game.clickedTiles.indexOf(i) != -1){
                                    // It was previously selected, and should be unselected
                                    var index = game.clickedTiles.indexOf(i);
                                    game.clickedTiles.splice(index,1);
                                    var index = game.selectedTiles.indexOf(game.tiles[i]);
                                    game.selectedTiles.splice(index,1);
                                }
                                else{
                                    // Select tile i
                                    game.selectedTiles.push(game.tiles[i]);
                                    game.clickedTiles.push(i);
                                }
                                // console.log(game.clickedTiles);
                                // console.log(game.selectedTiles);
                            }
                        }
                    }

                    // Click on banker selection button
                    if(x>bankerSelectionInfo[0] && x<bankerSelectionInfo[0]+bankerSelectionInfo[2] && y>bankerSelectionInfo[1] && y < bankerSelectionInfo[1]+bankerSelectionInfo[3]){
                        if(game.bankOnTurn){
                            game.bankOnTurn = false;
                            socket.emit('bank on turn',false);
                        }
                        else{
                            game.bankOnTurn = true;
                            socket.emit('bank on turn',true);
                        }
                    }
                });
			});

		</script>

		<div id="container">
			<div id="topbar"></div>
			<div id="leftbar"></div>
			<div id="gamewindow">
    				<!-- <div id="buttons">
    					<div id="betting Buttons">
    						<button id="bet5">Bet $5</button>
    						<button id="bet10">Bet $10</button>
    						<button id="bet25">Bet $25</button>
    						<button id="lockBet">Lock bet</button>
    						<button id="unlockBet">Unlock bet</button>
    					</div>
    					<div id="tileButtons">
    						<button id="lockPair">Lock Selection</button>
    						<button id="unlockPair">Unock Selection</button>
    					</div>
    					<div id="miscButtons">
    						<button id="quit">Quit</button>
    					</div>
    					<div id="gameInformation">
    						
    					</div>
    					<div id="tileSelection">
    						<div class="tile" id='one'>
    						</div>
    						<div class="tile" id='two'>
    						</div>
    						<div class="tile" id='three'>
    						</div>
    						<div class="tile" id='four'>
    						</div>
    					</div>
    				</div> -->

                <canvas id="game"></canvas>

    			<div>
    				<ul id="messages"></ul>
    			</div>

		      </div>
		      <div id="rightbar"></div>
	       </div>

    </body>



</html>